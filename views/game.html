<html>
    <head>
        <meta charset="utf-8">
        <style>
            html,body{
                width: 100%;
                margin: 0;
                padding:0;
                overflow-y: hidden;
            }
            #chessBoardDiv{
                width:100%;
                height: 100%;
            }
            #canvas {
                display: block;
                margin: 0;
                padding:0;
            }
            canvas  {
                position: absolute;
            }
            .chess_selected{
                border: 3px solid fuchsia;
            }
            #gameWindow{
                position:absolute;
                right:10;
                top:10;
                width: 300px;
                height: 300px;
                border: 1px solid black;
                overflow: auto;
                overflow-x:hidden;
            }
            #gameWindow div{
                margin: 2px;
            }
            #chatWindow{
                position:absolute;
                right:10;
                bottom:10;
                width: 300px;
                height: 450px;
                border: 1px solid black;
            }
            #operationWindow{
                position:absolute;
                border: 1px solid;
                left:10;
                top:10;
                z-index: 777;
                padding-bottom: 10px;
            }
           
            #pickDiv {
                display: block;
                z-index: 100;
            }
            #pickDiv input{
                width: 100px;
                height: 40px;
                font-size: 18px;
            }
             #prepareBtn{
                width:180px;
                height:40px;
                font-size: 20px;
            }
           
            #nickWrapper {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
                background-color: rgba(5, 5, 5, .6);
                text-align: center;
                color: #fff;
                display: block;
                padding-top: 200px;
                z-index: 888;
            }

            #nickNameInput{
                width: 600px;
                height: 100px;
                font-size: 30px;
            }
            #loginBtn{
                width: 100px;
                height: 100px;
                font-size: 30px;
            }
            #historyMsg {
                border:1px solid;width:300px;height:300px;
                overflow: auto;
            }
            #messageInput{
                width: 350px;
                height: 50px;
            }
           .messageSendDiv{
               margin-top:5px;
               display: flex;
           }
           #info{
               font-size: 44px;
               font-weight: bold;
               color:red;
               background-color: greenyellow;
           }
           #currentPlayer{
               font-size: 24px;
               color:red;
               background-color: #1c1c1c;
               font-weight: bold;
               display: block;
               text-align: center;
           }
           @-moz-keyframes heart_beat{

                0%{-moz-transform:scale(1)} 
                25%{-moz-transform:scale(2.0)} 
                50%{-moz-transform:scale(0.9)} 
                75%{-moz-transform:scale(2)} 
                100%{-moz-transform:scale(1)}
            } 
            @-webkit-keyframes heart_beat{
                0%{-webkit-transform:scale(1)} 
                25%{-webkit-transform:scale(2.0)} 
                50%{-webkit-transform:scale(0.9)} 
                75%{-webkit-transform:scale(2)} 
                100%{-webkit-transform:scale(1)}
            }
            @keyframes heart_beat{
                0%{-webkit-transform:scale(1)} 
                25%{-webkit-transform:scale(2.0)} 
                50%{-webkit-transform:scale(0.9)} 
                75%{-webkit-transform:scale(2)} 
                100%{-webkit-transform:scale(1)}
            }  
            #redBtn{ background-color: #ff6666}
            #yellowBtn{background-color: #ffcc00}
            #blueBtn{background-color: #99ccff}
            #greenBtn{background-color: #66cc00}

        
        </style>
    </head>
    <body>
        <div id="chessBoardDiv">
            <canvas id="canvas" ></canvas>
        </div>
        <div id="nickWrapper" >
            <div id="info">
            </div>
            <input id='nickNameInput' value="kdr20151005" placeholder="输入开采夫员工编号"/> 
            <input id="loginBtn"  value="ok" type="button" />
        </div>
        <div id="gameWindow">  
            <h3>游戏窗口</h3> 
            <span>游戏状态：</span>
            <span id='gameState'>选人状态</span> 
            <span id='currentPlayer'></span>
        </div>
        <div id='operationWindow'>
            <h3>选择窗口</h3>
            <div id="pickDiv">
                <div id="playerPickDiv">
                    <input value='选择红方' style="margin-left:105px;" type="button" id="redBtn" data='red' />
                    <br/>
                    <input value='选择黄方' style="margin-right:0px;" type="button" id="yellowBtn" data='yellow' />
                    <input value="准备" type="button" id="prepareBtn" style="height:80px;width:96px;" disabled/>
                    <input value='选择蓝方' style="" type="button" id="blueBtn" data='blue'/>
                    <br/>
                    <input value='选择绿方' style="margin-left:105px;" type="button" id="greenBtn" data='green'/>
                </div>
                <input value='安静的做个观众' style="width:260px;height:30px;margin-left:25px;margin-top:35px;background:pink;" id="observerBtn" type="button" data="observer"/>
            </div>
        </div>
        <div id="chatWindow">
            <h3>聊天窗口</h3>
            <div id='status'>在线人数</div>
            <div id="historyMsg" style=""></div>
            <div class="messageSendDiv">
                <textarea id='messageInput'></textarea>
                <input type="button" value="发送" id="sendBtn"/>
            </div>
        </div>
    </body>
    <script src="js/socket.io-1.4.5.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/algo.js"></script>
    <script>
        !function(){
            // kcharf array 扩展
            Array.prototype.in_array = function(e)
            {
                for(i=0;i<this.length;i++)
                {
                if(this[i] == e)
                return true;
                }
                return false;
            }
        }();
        
var canvas = document.getElementById('canvas');

var ctx = canvas.getContext('2d');
var firstCamp = null;
var secondCamp = null;
var pieces =['司令','军长','师长','师长','旅长','旅长','团长','团长','营长','营长','炸弹','炸弹','连长','连长','连长','排长','排长', '排长','工兵','工兵','工兵','地雷','地雷','军旗','地雷'];
var players=['green', 'blue','red', 'yellow'];
 var chessBoard = [];
var maxRows= 17;
var maxCols = 17;
var chessW = 40;
var chessH = 20;
var hichat;
var game;
var Vertex2d = function(x, y){
    this.x = x;
    this.y = y;
}
var railRoadBound = [
    {lt: new Vertex2d(1,6), rb: new Vertex2d(5, 10)},
    {lt: new Vertex2d(6,1), rb: new Vertex2d(10, 5)},
    {lt: new Vertex2d(11,6), rb: new Vertex2d(15, 10)},
    {lt: new Vertex2d(6,11), rb: new Vertex2d( 10, 15)},
];
var moveCampIdxAry = [
        '12,7','12,9','13,8','14,7','14,9', 
        '4,7','4,9','3,8','2,7','2,9',
        '7,4','9,4','8,3','7,2','9,2',
        '7,12','9,12','8,13','7,14','9,14'
        ]; //行营索引集
var homeCampIdxAry = [
        '16,7','16,9', 
        '0,7','0,9',
        '7,0','9,0',
        '7,16','9,16'
        ]; //大本营索引集
var middleCampIdxAry = [
    [6,6],[6,8],[6,10],
    [8,6],[8,8],[8,10],
    [10,6],[10,8],[10,10],
];

var boundsWidth = 820;
var boundsHeight = 820;
var boundsCenterX =window.innerWidth / 2; 
var ltx = boundsCenterX - boundsWidth / 2 ;
var rbx = ltx + boundsWidth;
var boundsCenterY =window.innerHeight / 2; 
var lty = boundsCenterY - boundsHeight / 2 ;
var rby = lty + boundsHeight;
var bounds = {
    lt: new Vertex2d(ltx,lty),
    rb: new Vertex2d(rbx, rby),
    vgap : function(){
        return (this.rb.y - this.lt.y) / (maxCols-1);
    },
    hgap : function(){
        return (this.rb.x - this.lt.x) / (maxRows-1);
    }
}
var RailRoad = function(x,y, x1, y1){
    this.x = x;
    this.y = y;
    this.x1 = x1;
    this.y1 = y1;
}
var railRoadRowAry = [1, 5, 6, 8, 10, 11, 15];
var railRoadColAry = [1, 5, 6, 8, 10, 11, 15];
var railRoadRowDic = {};
var railRoadColDic = {};

function initRailRoadDataSource(){
    railRoadRowAry.forEach(function(d, i){
        railRoadRowDic[d] = [];
    })
    railRoadColAry.forEach(function(d, i){
        railRoadColDic[d] = [];
    })
    for (var i = 6 ; i < 11; i++){
        var ary = [];
        var col = [];
        ary.push(i, 1);
        col.push(1, i);
        railRoadRowDic[1].push(ary);
        railRoadColDic[1].push(col);
        ary = [];
        col = [];
        ary.push(i, 5);
        col.push(5, i);
        railRoadRowDic[5].push(ary);
        railRoadColDic[5].push(col);
        ary = [];
        col = [];
        ary.push(i, 11);
        col.push(11, i);
        railRoadRowDic[11].push(ary);
        railRoadColDic[11].push(col);
        ary = [];
        col = [];
        ary.push(i, 15);
        col.push(15, i);
        railRoadRowDic[15].push(ary);
        railRoadColDic[15].push(col);
    } 
    for(var i = 1; i < 16; i++){
        var ary = [];
        var col = [];
        ary.push(i, 6);
        col.push(6, i);
        railRoadRowDic[6].push(ary);
        railRoadColDic[6].push(col);
        ary = [];
        col = [];
        ary.push(i, 10);
        col.push(10, i);
        railRoadRowDic[10].push(ary);
        railRoadColDic[10].push(col);
    }
    for(var i = 5; i < 12; i++){
        var ary = [];
        var col = [];
        ary.push(i, 8);
        col.push(8, i);
        railRoadRowDic[8].push(ary);
        railRoadColDic[8].push(col);
    }
}

initRailRoadDataSource();

var drawCamp =  function(camp, i, j, player, _showChessName){
    if(moveCampIdxAry.in_array(String.prototype.concat(i,',',j))){
        camp.type= '行营';
        camp.draw();
        return;
    }
    if(homeCampIdxAry.in_array(String.prototype.concat(i,',',j))){
        camp.type =  '大本营';
        camp.draw();
        if(player){
            var chess = player.getChess();
            if(_showChessName){
                chess.isShowName = true;
            }else{
                chess.isShowName = false;
            }
            camp.drawChess(chess);
        }
        return;
    }
    camp.type = '兵站';
    camp.draw();
    if(player){
        var chess = player.getChess();
        if(_showChessName){
            chess.isShowName = true;
        }
        camp.drawChess(chess);
    }
}

var config = {
    state: {
        pick: '选人状态', 
        preparing: '准备中',
        prepared: '已准备',
        started: '已开始',
        over: '已结束'
    },
    color: {
        red: '#ff6666',
        yellow: '#ffcc00',
        blue: '#99ccff',
        green: '#66cc00'
    },
    judgment: {
        win: 'win',
        success: 'success',
        fail: 'fail',
        die: 'die' //平了 双方都阵亡
    },
    rotate:{
        red: 180,
        green: 0,
        yellow: 270,
        blue: 90
    }
}
var Camp = function(x, y, rowIdx, colIdx){
    this.type = '';
    this.colorType = '';
    this.originX = x;
    this.originY = y;
    this.fillColor = '#fff';
    this.rowIdx = rowIdx;
    this.colIdx = colIdx;
    this.isClick = false;
    this.filledChess = null; 
    this.id = 'camp'+rowIdx+'_'+colIdx;
    this.canvas = document.createElement('canvas');

    this.addCamp = function(){
        this.canvas.setAttribute('width', this.campWidth);
        this.canvas.setAttribute('height', this.campHeight);
        this.canvas.setAttribute('class', 'camp_canvas');
        this.canvas.setAttribute('id', this.id);
        this.canvas.style.left = this.x;
        this.canvas.style.top = this.y;
        document.getElementById('chessBoardDiv').appendChild(this.canvas);
        game.camps[this.id] = this;
        this.draw();
    }
    this.addChess = function(chess){
        this.filledChess = chess;
        chess.addChess(this);
    }

    this.draw = function(){
        // this.clearRect();
        var ctx = this.canvas.getContext('2d');
        ctx.strokeStyle = '#1c1c1c';
        ctx.fillStyle = '#fff';
        if(this.type == '行营'){
            ctx.beginPath();
            ctx.arc(this.campWidth/2, this.campHeight/2, this.campWidth/2-1, 0, Math.PI*2);
            ctx.stroke();
            ctx.fill();
        }else{
            ctx.strokeRect(1, 1, this.campWidth -2,this.campHeight-2);
            ctx.fillRect(1, 1,this.campWidth-2,this.campHeight-2);
        }
         this.drawText(this.type);
    }  

    this.drawText = function(text){
        var ctx = this.canvas.getContext('2d');
        ctx.save(); 
        // 填充文字
        // 旋转之前将画布的中心位置translate到对象的中心点
        if(typeof(this.rotateRadian) !== 'undefined' ){
            ctx.translate(this.campWidth/2, this.campHeight/2);
            ctx.rotate(this.rotateRadian);
            ctx.translate(-this.campWidth/2, -this.campHeight/2);
        }
        ctx.font = 'normal 12px 微软雅黑';
        ctx.fillStyle = '#000';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, this.campWidth/2,  this.campHeight/2);
        ctx.restore();
    }

}
Camp.prototype ={
    setType:function(type){
        this.type = type;
    },
    setSize: function(w, h){
        this.chessWidth = w;
        this.chessHeight = h;
        this.campWidth = w;
        this.campHeight = h;
        if(this.type == '行营'){
            this.campWidth = 50;
            this.campHeight = 50;
        }
        this.x = this.originX - this.campWidth/2;
        this.y = this.originY - this.campHeight/2;
    },
    setTextRotate : function(radian){
        this.rotateRadian = radian; // 弧度 Math.PI
    },
    setFill: function(fillColor){
        this.fillColor = fillColor;
    },
    setClicked: function(){
        if(this.filledChess == null) return;
        this.isClick = this.isClick ? false: true;
        if(this.isClick){
            this.drawBounds();
        }else{
            this.clearBounds();
        }
    },
    drawBounds: function(){
        var that = this;
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#000';
        ctx.strokeRect(that.x, that.y, that.chessWidth, that.chessHeight);
    },
    clearBounds: function(){
        this.clearRect();
        this.draw();
        if(this.filledChess != null){
            this.drawChess(this.filledChess);
        }
    },
    clearRect: function(){
        this.isClick = false;
        ctx.clearRect(this.x-2, this.y-2, this.chessWidth+4, this.chessHeight+4);
    },
    clearFilledChess:function(){
        this.filledChess = null;
    }
};  
var Chess = function(){
    this.name = '';
    this.fillColor = '#000';
    this.isShowName = false;
    this.type = '';
    this.camp;
    this.chessWidth;
    this.chessHeight;
    this.x;
    this.y;
    this.rotateRadian;
    this.chessCanvas = document.createElement('canvas');
}
Chess.prototype = {
    addChess:function(camp){
        this.camp = camp;
        this.chessWidth = camp.chessWidth;
        this.chessHeight = camp.chessHeight;
        this.rotateRadian = camp.rotateRadian;
        this.x = this.camp.x + (this.camp.campWidth - this.chessWidth) / 2;
        this.y = this.camp.y + (this.camp.campHeight - this.chessHeight) / 2;
        this.chessCanvas.setAttribute('width', this.chessWidth);
        this.chessCanvas.setAttribute('height', this.chessHeight);
        this.chessCanvas.setAttribute('class', 'chess_canvas  chess_canvas_'+this.type);
        this.chessCanvas.style.left = this.x;
        this.chessCanvas.style.top = this.y;
        this.chessCanvas.setAttribute('id', this.id);
        document.getElementById('chessBoardDiv').appendChild(this.chessCanvas);
        this.drawChess();
        game.chesses[this.id] = this;
    },
    drawChess:function(){
        var ctx = this.chessCanvas.getContext('2d');
        ctx.fillStyle = this.fillColor;
        ctx.fillRect(1 , 1 ,this.chessWidth-2,this.chessHeight-2);
        ctx.save(); 
        if(typeof(this.rotateRadian) !== 'undefined' ){
            ctx.translate(this.chessWidth/2, this.chessHeight/2);
            ctx.rotate(this.rotateRadian);
            ctx.translate(-this.chessWidth/2, -this.chessHeight/2);
        }
        if(this.isShowName ){
            ctx.font = 'bold 14px 微软雅黑';
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(this.name, this.chessWidth/2,  this.chessHeight/2 );
        }
        ctx.restore();
    },
    redraw:function(){
        this.x = this.camp.x + (this.camp.campWidth - this.chessWidth) / 2;
        this.y = this.camp.y + (this.camp.campHeight - this.chessHeight) / 2;
        this.chessCanvas.style.left = this.x;
        this.chessCanvas.style.top = this.y;
        var that = this;
        function computeRotate(){
            if(that.camp.colorType != ''){
                var idx1 = players.indexOf(that.camp.colorType);
                var idx2 = players.indexOf(that.type);
                var gap = Math.abs(idx1 - idx2);
                var rotateDeg = 0;
                rotateDeg = gap * 90;
                that.chessCanvas.style.transform = 'rotate('+rotateDeg+'deg)';
            }
        }
        computeRotate();
    },
    setCamp: function(camp){
        this.camp.filledChess = null;
        this.camp = camp;
        camp.filledChess = this;
    },
    destroy: function(){
        this.camp.filledChess = null;
        $('#'+this.id).remove();
        delete game.chesses[this.id];

    }
}

var Player = function(type){
    this.name = '';
    this.type = type; // red , yellow, blue, green
    this.teamPlayer = null; // 队友
    this.nextPlayer = null; // 下家，右方的席位
    this.lastPlayer = null; // 上家，左方的席位
    this.chesses = [];
    this.chessIdx = 0;
    this.isOnline = false; 
    this.state = config.state.pick;
    this.initChess();
    this.fristChess;
    this.secondChess;
}

Player.prototype = {
    initChess: function(serverChess){
        if(serverChess){
            this.chesses = [];
            for(var i = 0 ; i < serverChess.length; i++){
                var chess = new Chess();
                chess.id = serverChess[i].id;
                chess.name = serverChess[i].name;
                chess.type = serverChess[i].type;
                chess.fillColor = config.color[chess.type];
                if(this.type == chess.type){
                    chess.isShowName = true;
                }else{
                    chess.isShowName = false;
                }
                if(this.type == 'observer'){
                    chess.isShowName = true;
                }
                this.chesses.push(chess);
                game.camps[serverChess[i].campId].addChess(chess);
            }
        }else{
            this.chesses = [];
            for(var i = 0 ; i < pieces.length; i++){
                var chess = new Chess();
                chess.name = pieces[i];
                chess.fillColor = config.color[this.type];
                chess.type = this.type;
                chess.isShowName = false;
                chess.id = chess.type+i;
                this.chesses.push(chess); 
            }
        }
    },
    getChess : function(){
        if(this.chessIdx == 25){
            this.chessIdx = 0;
        }
        return this.chesses[this.chessIdx++]
    },
    getType: function(){
        if(this.type == 'red'){
            return '红方';
        }else if(this.type == 'blue'){
            return '蓝方';
        }else if(this.type == 'yellow'){
            return '黄方';
        }else if(this.type == 'green'){
            return '绿方';
        }
        return '未选择';
    },
    setOnline: function(isOnline){
        this.isOnline = isOnline;
    },
    setName: function(name){    
        this.name = name;
    },
    setType: function(type){
        this.type = type;
    },
    setState: function(state){
        this.state = state;
    },
    renderServerChess: function(){

    },
    renderPrepare: function(){
        this.initChess();
        // 暂不区分 主视角
        // 下方 （玩家主视角)  green
        for(var i = 11; i < 17; i++){
            for(var j= 6; j < 11; j++){
                var camp = chessBoard[i][j];
                if(camp.type == '行营') continue;
                var chess = hichat.greenPlayer.getChess();
                if(hichat.player.type == 'green' || hichat.player.type == 'observer'){
                    chess.isShowName = true;
                }else{
                    chess.isShowName = false;
                }
                camp.addChess(chess);
            }
        }
        /// 上方  red
        for(var i = 5; i >= 0; i--){
            for(var j= 6; j < 11; j++){
                var camp = chessBoard[i][j];
                if(camp.type == '行营') continue;
                var chess = hichat.redPlayer.getChess();
                if(hichat.player.type == 'red' || hichat.player.type == 'observer'){
                    chess.isShowName = true;
                }else{
                    chess.isShowName = false;
                }
                camp.addChess(chess);
            }
        }
        //  左方 yellow
        for(var j = 5; j >=0; j--){
            for(var i= 6; i < 11; i++){
                var camp = chessBoard[i][j];
                if(camp.type == '行营') continue;
                var chess = hichat.yellowPlayer.getChess();
                if(hichat.player.type == 'yellow' || hichat.player.type == 'observer'){
                    chess.isShowName = true;
                }else{
                    chess.isShowName = false;
                }
                camp.addChess(chess);
            }
        }
        // 右方 blue
        for(var j = 11; j <17; j++){
            for(var i= 6; i < 11; i++){
                var camp = chessBoard[i][j];
                if(camp.type == '行营') continue;
                var chess = hichat.bluePlayer.getChess();
                if(hichat.player.type == 'blue' || hichat.player.type == 'observer'){
                    chess.isShowName = true;
                }else{
                    chess.isShowName = false;
                }
                camp.addChess(chess);
            }
        }
    },
    initOtherPlayer: function(){ // 默认红黄绿蓝 逆时针续
        var nextPlayer = new Player();
        var teamPlayer = new Player();
        var lastPlayer = new Player();
        if(this.type == 'red'){
            nextPlayer.type = 'yellow';
            teamPlayer.type = 'green';
            lastPlayer.type = 'blue';
        }
        if(this.type == 'yellow'){
            nextPlayer.type = 'green';
            teamPlayer.type = 'blue';
            lastPlayer.type = 'red';
        }
        if(this.type == 'green'){
            nextPlayer.type = 'blue';
            teamPlayer.type = 'red';
            lastPlayer.type = 'yellow';
        }
        if(this.type == 'blue'){
            nextPlayer.type = 'red';
            teamPlayer.type = 'yellow';
            lastPlayer.type = 'green';
        }
        this.nextPlayer = nextPlayer;
        this.teamPlayer = teamPlayer;
        this.lastPlayer = lastPlayer;

        switch(this.type){
            case 'red':
            hichat.redPlayer = hichat.player;
            hichat.greenPlayer = new Player('green');
            hichat.yellowPlayer = new Player('yellow');
            hichat.bluePlayer = new Player('blue');
            break;
            case 'green':
            hichat.greenPlayer = hichat.player;
            hichat.redPlayer = new Player('red');
            hichat.yellowPlayer = new Player('yellow');
            hichat.bluePlayer = new Player('blue');
            break;
            case 'yellow':
            hichat.yellowPlayer = hichat.player;
            hichat.greenPlayer = new Player('green');
            hichat.redPlayer = new Player('red');
            hichat.bluePlayer = new Player('blue');
            break;
            case 'blue':
            hichat.bluePlayer = hichat.player;
            hichat.greenPlayer = new Player('green');
            hichat.yellowPlayer = new Player('yellow');
            hichat.redPlayer = new Player('red');
            break;
            case 'observer':
            hichat.bluePlayer = new Player('blue');
            hichat.greenPlayer = new Player('green');
            hichat.yellowPlayer = new Player('yellow');
            hichat.redPlayer = new Player('red');
            break;
        }
    },
    findPlayerByType: function(type){
        if(this.type == type){
            return this;
        }
        if(this.nextPlayer.type == type){
            return this.nextPlayer;
        }
        if(this.teamPlayer.type == type){
            return this.teamPlayer;
        }
        if(this.lastPlayer.type == type){
            return this.lastPlayer;
        }
    },
    findPlayerByName: function(name){
        if(this.nextPlayer && this.nextPlayer.name == name){
            return this.nextPlayer;
        }
        if(this.teamPlayer && this.teamPlayer.name == name){
            return this.teamPlayer;
        }
        if(this.lastPlayer && this.lastPlayer.name == name){
            return this.lastPlayer;
        }
        return this;
    },
    preparing:function(){
        //进入准备状态
        $('.chess_canvas_'+this.type).bind('click', this.exchangeChess);
    },
    prepared:function(){
        //准备完成状态
        $('.chess_canvas_'+this.type).unbind('click', this.exchangeChess);
        if(Player.prototype.firstChess){
            $(Player.prototype.firstChess).removeClass('chess_selected');
            Player.prototype.firstChess = null;
        }
    },
    gameStart:function(){
        // 游戏开始
        $('.chess_canvas_'+this.type).bind('click', this.moveChess);
        // $('.camp_canvas').bind('click', this.exchangeChess);
    },
    offOrder:function(){
         $('.chess_canvas_'+this.type).unbind('click', this.moveChess);
         $('.camp_canvas').unbind('click');
         $('.chess_canvas_'+hichat.player.lastPlayer.type).unbind('click');
         $('.chess_canvas_'+hichat.player.nextPlayer.type).unbind('click');
         if(this.prepareMovedChess){
             $(this.prepareMovedChess).removeClass('chess_selected');
             this.prepareMovedChess = null;
         }
    },
    moveChess: function(e){
        if($(e.target).hasClass('chess_selected')){
           $(e.target).removeClass('chess_selected');
           hichat.player.prepareMovedChess = null; 
           $('.camp_canvas').unbind('click');
           $('.chess_canvas_'+hichat.player.lastPlayer.type).unbind('click');
           $('.chess_canvas_'+hichat.player.nextPlayer.type).unbind('click');
        }else{
            var selectedChess = game.chesses[e.target.id];
            if(selectedChess.name == '地雷' || selectedChess.camp.type == '大本营'){
                return;
            }
            if( !hichat.player.prepareMovedChess ){
                 //地雷不能选, 大本营中的子不能选
                $('.camp_canvas').bind('click', function(evt){
                    console.log('选择了camp,准备进营 ',evt.target);
                    var selectedChess = game.chesses[hichat.player.prepareMovedChess.id];
                    var complete = hichat.player.occupyCamp(evt.target);
                    if(complete){
                        hichat.player.offOrder();
                        hichat.broadcastOccupy(selectedChess.type, selectedChess.id, evt.target.id);
                    }
                });
                 $('.chess_canvas_'+hichat.player.lastPlayer.type).bind('click', function(evt){
                    console.log('选择了对手棋子,准备进攻 ',hichat.player.lastPlayer.type ,evt.target);
                    var selectedChess = game.chesses[hichat.player.prepareMovedChess.id];
                    var complete = hichat.player.attackChess(evt.target);
                    if(complete){
                        hichat.player.offOrder();
                        hichat.broadcastAttack(selectedChess.type, selectedChess.id, evt.target.id);
                    }
                 });
                 $('.chess_canvas_'+hichat.player.nextPlayer.type).bind('click', function(evt){
                    console.log('选择了对手棋子,准备进攻 ',hichat.player.nextPlayer.type,evt.target);
                    var selectedChess = game.chesses[hichat.player.prepareMovedChess.id];
                    var complete = hichat.player.attackChess(evt.target);
                    if(complete){
                        hichat.player.offOrder();
                        hichat.broadcastAttack(selectedChess.type, selectedChess.id, evt.target.id);
                    }
                 });
            }else{
                $(hichat.player.prepareMovedChess).removeClass('chess_selected');
            }
            $(e.target).addClass('chess_selected');
            hichat.player.prepareMovedChess = e.target;
        }
    },
    occupyCamp: function(targetCamp){
        var chess = game.chesses[this.prepareMovedChess.id];
        var availCamps = computeAvailCamp(chess.camp);
        var camp = game.camps[targetCamp.id];
        console.log(availCamps)
        if(availCamps.indexOf(camp) != -1){
            chess.setCamp(camp);
            chess.redraw();
            return true;
        }else{
            alert('行进不合法');
            return false;
        }
    },
    attackChess: function(targetChess){
        var attackedChess = game.chesses[targetChess.id];
        var chess = game.chesses[this.prepareMovedChess.id];
        var availCamps = computeAvailCamp(chess.camp);
        if(availCamps.indexOf(attackedChess.camp) != -1){
            var result = GameRule.judgment(chess, attackedChess);
            console.log(result)
            switch(result){
                case config.judgment.win:
                chess.destroy();
                break;
                case config.judgment.die:
                chess.destroy();
                attackedChess.destroy();
                break;
                case config.judgment.success:
                attackedChess.destroy();
                chess.setCamp(attackedChess.camp);
                chess.redraw();
                break;
                case config.judgment.fail:
                chess.destroy();
                break;
            }

            return true;
        }else{
            alert('行进不合法');
            return false;
        }
    },
    exchangeChess: function(e){
        //调配旗子
        if($(e.target).hasClass('chess_selected')){
           $(e.target).removeClass('chess_selected');
           Player.prototype.firstChess = null; 
        }else{
            if(Player.prototype.firstChess){
                Player.prototype.swapChess(e.target,Player.prototype.firstChess);
                $(Player.prototype.firstChess).removeClass('chess_selected');
                Player.prototype.firstChess = null;
            }else{
                Player.prototype.firstChess = e.target;
                $(e.target).addClass('chess_selected');
            }
        }
    },
    swapChess:function(secondChess, firstChess){
        // 判断是否符合交换规则
        var chess2 = game.chesses[$(secondChess).attr('id')];
        var chess1 = game.chesses[$(firstChess).attr('id')];
        // // 炸弹不能在第一排
        if(chess2.name == '炸弹' || chess1.name =='炸弹'){
            if( chess2.camp.rowIdx == 11 || chess1.camp.rowIdx == 11 || chess2.camp.rowIdx == 5 || chess1.camp.rowIdx == 5){
                alert('炸弹不能在第一排');
                return;
            }
            if( chess2.camp.colIdx == 11 || chess1.camp.colIdx == 11 || chess2.camp.colIdx == 5 || chess1.camp.colIdx == 5){
                alert('炸弹不能在第一排');
                return;
            }
        }
        // // 地雷只能在后两排
        if(chess2.name  == '地雷' || chess1.name =='地雷'){
            if(chess2.type == 'green' && (chess2.camp.rowIdx  < 15 || chess1.camp.rowIdx < 15 )){
                alert('地雷只能在后两排');
                return;
            }
            if(chess2.type == 'red' && (chess2.camp.rowIdx  > 1 || chess1.camp.rowIdx > 1)){
                alert('地雷只能在后两排');
                return;
            }
            if(chess2.type == 'yellow' && (chess2.camp.colIdx  > 1 || chess1.camp.colIdx > 1)){
                alert('地雷只能在后两排');
                return;
            }
            if(chess2.type == 'blue' && (chess2.camp.colIdx  < 15 || chess1.camp.colIdx < 15)){
                alert('地雷只能在后两排');
                return;
            }
        }
        // // 军旗只能在大本营
        if(chess2.name == '军旗' || chess1.name  =='军旗'){
            if( homeCampIdxAry.indexOf(chess2.camp.rowIdx+','+chess2.camp.colIdx) == -1 || homeCampIdxAry.indexOf(chess1.camp.rowIdx+','+chess1.camp.colIdx) == -1){
                alert('军旗只能在大本营');
                return;
            }
        }
        var id1 = chess1.camp.id;
        var id2 = chess2.camp.id;
        var temp = chess2.camp;
        chess2.setCamp(chess1.camp);
        chess1.setCamp(temp);
        
        chess2.redraw();
        chess1.redraw();
        hichat.broadcastExchangeChess(id1, id2);
    }
    
}

var HiChat = function(){
    this.socket = null;
    this.player = null;
    this.firstCamp = null;
    this.secondCamp = null;
    this.playerDic = {}; 
    this.observer = null;
}

HiChat.prototype = {
    init: function(){
        this.initPlayer();
        var that = this;
        this.socket = io.connect();
        this.socket.on('connect', function(){
            document.getElementById('nickWrapper').style.display = 'block';
            document.getElementById('nickNameInput').focus();
            
        })
        document.getElementById('sendBtn').addEventListener('click', function(){
            var messageInput = document.getElementById('messageInput'), 
                msg = messageInput.value;
                messageInput.value = '';
                messageInput.focus();
                if(msg.trim().length != 0){
                    that.socket.emit('postMsg', msg); //把消息发送到服务器
                    that._displayNewMsg(that.player.name, msg); //把自己的消息显示到自己的窗口中 
                }
        }, false);
        document.getElementById('messageInput').addEventListener('keypress', function(e){
            if(e.keyCode == '13'){
                e.preventDefault();
                var msg = e.target.value.trim();
                e.target.value = '';
                e.target.focus();
                if(msg.length !=0){
                    that.socket.emit('postMsg', msg);
                    that._displayNewMsg(that.player.name, msg); //把自己的消息显示到自己的窗口中 
                }
            }
        });
        document.getElementById('loginBtn').addEventListener('click', function() {
            var nickName = document.getElementById('nickNameInput').value.trim();
            //检查昵称输入框是否为空
            if (nickName.trim().length != 0) {
                //不为空，则发起一个login事件并将输入的昵称发送到服务器
                that.socket.emit('login', nickName);
            } else {
                //否则输入框获得焦点
                document.getElementById('nickNameInput').focus();
            };
        }, false);
        document.getElementById('nickNameInput').addEventListener('keypress', function(e){
            if(e.keyCode == '13'){
                var nickName = document.getElementById('nickNameInput').value.trim();
                //检查昵称输入框是否为空
                if (nickName.trim().length != 0) {
                    //不为空，则发起一个login事件并将输入的昵称发送到服务器
                    that.socket.emit('login', nickName);
                } else {
                    //否则输入框获得焦点
                    document.getElementById('nickNameInput').focus();
                };
            }
        });

        this.socket.on('nickExisted', function(){
            document.getElementById('info').textContent = '用户已存在';
        })
        this.socket.on('loginSuccess', function(nickName, gameState, playerState, chessState){
            document.getElementById('nickWrapper').style.display = 'none';
            document.getElementById('messageInput').focus();
            that.player.name = nickName;
            document.getElementById('gameState').innerHTML = gameState;
            game.state = gameState;
            game.chessState = chessState;
            that._initPickedPlayerState(playerState, chessState);
            
        });
        this.socket.on('system', function(nickName, userCount, type){
            var msg = nickName + (type == 'login' ? ' 加入' : ' 离开');
            that._displayNewMsg('system', msg, 'red');
            document.getElementById('status').textContent = userCount+'个用户在线';
            
            if(!that.playerDic.hasOwnProperty(nickName)){ //只有选人了 才会在玩家字典中加入数据 
                return;
            }
            var player = that.playerDic[nickName];
            if(type == 'login'){
                player.setOnline(true);
            }else{
                player.setOnline(false);
            }
                that.refreshPlayerState(player);
        });
        this.socket.on('newMsg', function(nickName, msg){
            that._displayNewMsg(nickName, msg);
        });
        this.socket.on('EmpIdNotFound', function(){
            document.getElementById('info').textContent = '员工编号不存在';
        });

        // 游戏模块
        this.socket.on('event_pick', function(name, type, state){
            if(type == 'observer'){
                var ob = new Observer();
                ob.name = name;
                ob.isOnline = true;
                that.observer = ob;
                that.refreshObserverState(ob);
            }else{
                var player = new Player();
                player.name = name;
                player.type = type;
                player.state = state;
                player.isOnline = true;
                that.refreshPlayerState(player);
                that.playerDic[name] = player;
                document.getElementById(type+'Btn').setAttribute('disabled', 'true');
            }
        });
        this.socket.on('event_prepare', function(name, state){
            var player = that.playerDic[name];
            if(player){
                player.state = state;
                that.refreshPlayerState(player);
            }
        });
        this.socket.on('game_start', function(){
            that._displayNewMsg('game', '所有玩家已准备，游戏开始');
            document.getElementById('gameState').innerHTML = config.state.started;
            document.getElementById('prepareBtn').setAttribute('disabled', true);
            game.state = config.state.started;
        });
        this.socket.on('game_prepare', function(){
            that._displayNewMsg('game', '所有玩家已选择席位，游戏准备中');
            if(hichat.player.type != 'observer'){
                document.getElementById('prepareBtn').removeAttribute('disabled');
            }
            document.getElementById('gameState').innerHTML = config.state.preparing;
            game.state = config.state.preparing;
            game.init();
            that.player.renderPrepare();
            that.player.preparing();
        });
        this.socket.on('event_occupy', function(chessId, campId){
            var chess = game.chesses[chessId];
            var camp = game.camps[campId];
            game.showMoveRoute(chess.camp, camp, callback);
            function callback(){
                chess.camp.clearFilledChess();
                chess.setCamp(camp);
                chess.redraw();
            }
        });
        this.socket.on('event_attack', function( chessId, targetChessId){
            var chess = game.chesses[chessId];
            var attackedChess = game.chesses[targetChessId];
            game.showMoveRoute(chess.camp, attackedChess.camp, callback);
            function callback(){
                var result = GameRule.judgment(chess, attackedChess);
                switch(result){
                    case config.judgment.win:
                    chess.destroy();
                    //被攻击方军旗被抗
                    game.playerOver(attackedChess.type);
                    break;
                    case config.judgment.die:
                    chess.destroy();
                    attackedChess.destroy();
                    break;
                    case config.judgment.success:
                    attackedChess.destroy();
                    chess.setCamp(attackedChess.camp);
                    chess.redraw();
                    break;
                    case config.judgment.fail:
                    chess.destroy();
                    break;
                }
            }
        });
        this.socket.on('event_turnorder', function(nextType, nextPlayer){
            that._changeCurrentPlayer(nextType, nextPlayer);
            if(nextType == that.player.type){
                game.isOnOrder = true;
                hichat.player.gameStart();
            }
        });
        this.socket.on('event_exchangeChess_prepare', function(firstCampId, secondCampId){
            var chess1 = game.camps[firstCampId].filledChess;
            var chess2 = game.camps[secondCampId].filledChess;
            var temp = chess2.camp;
            chess2.setCamp(chess1.camp);
            chess1.setCamp(temp);
            chess2.redraw();
            chess1.redraw();
        });
        this.socket.on('event_player_over', function(type, name){
            // 更新玩家状态信息 
            var player = that.playerDic[name];
            player.state = config.state.over;
            that.refreshPlayerState(player);
            // 移除该玩家旗子
            for(var id in game.chesses){
                if(id.startsWith(type)){
                    game.chesses[id].destroy();
                    delete game.chesses[id];
                }
            }
        })
        this.socket.on('event_game_over', function(){
            game.state = config.state.over; 
            that._displayNewMsg('system', '游戏结束', 'red');
            document.getElementById('gameState').innerHTML = '游戏结束';
            document.getElementById('currentPlayer').innerHTML = '';
        })
        
        //pick 
        document.getElementById('pickDiv').addEventListener('click', function(e){
            
            if(that.player.state == config.state.pick){
                if(e.target.hasAttribute('data')){
                    var dataType = e.target.getAttribute('data'); // 选择了其中一席，不能再改变
                    that.socket.emit('event_pick', that.player.name, dataType, config.state.preparing);
                    that.socket.on('seatSelected', function(name, type){
                        alert(game.getType(type)+'已被'+name+'选择,请选择其他席位');
                        e.target.disabled = true;
                        return;
                    });
                    that.socket.on('event_pick_success', function(){
                        e.target.disabled = true;
                        $('#pickDiv input').attr('disabled', true);
                        that.player.setType(dataType);
                        that.player.isOnline = true;
                        that.player.setState(config.state.preparing);
                        if(that.player.type == 'observer'){
                            that.refreshObserverState(that.player);
                            if(game.state == config.state.preparing || game.state == config.state.started){
                                game.init();
                                that.player.initChess(JSON.parse(game.chessState));
                            }
                        }else{
                            that.refreshPlayerState(that.player);
                        }
                        that.player.initOtherPlayer();
                        that.playerDic[that.player.name] = that.player;
                        //仅作测试用
                        if(game.mock_preparing){
                            game.init();
                            that.player.renderPrepare();
                            that.player.preparing();
                        }
                        if(game.mock_started){
                            game.init();
                            that.player.renderPrepare();
                            that.player.gameStart();
                        }
                    });
                }
            }
        });
        //准备阶段
        document.getElementById('prepareBtn').addEventListener('click', function(event){
            if(that.player.state == config.state.pick){
                alert('当前处于选人状态，请先选择一方席位');
                return;
            }
            if(event.currentTarget.value == '准备'){
                event.currentTarget.setAttribute('value', '取消准备');
                that.player.state = config.state.prepared;
                that.player.prepared();
            }else{
                event.currentTarget.setAttribute('value', '准备');
                that.player.state = config.state.preparing;
            }
            that.refreshPlayerState(that.player);
            that.socket.emit('event_prepare', that.player.name, that.player.state);
        });                
    },
    _displayNewMsg: function(user, msg, color){
        var container = document.getElementById('historyMsg'),
            msgToDisplay = document.createElement('p'),
            date = new Date().toTimeString().substr(0, 8);
        msgToDisplay.style.color = color || '#000';
        msgToDisplay.innerHTML = user + '<span class="timespan">('+date+'):</span>'+msg;
        container.appendChild(msgToDisplay);
        container.scrollTop = container.scrollHeight; 
    },
    _changeCurrentPlayer : function(nextType, nextPlayer){
        document.getElementById('currentPlayer').innerHTML = '&nbsp;轮到 ['+game.getType(nextType)+'] '+nextPlayer+'';
        document.getElementById('currentPlayer').style.color = config.color[nextType];
        document.getElementById('currentPlayer').style.animation = "heart_beat 2s ease-in-out";
        document.getElementById('currentPlayer').style.webkitAnimation = "heart_beat 2s ease-in-out";
        document.getElementById('currentPlayer').style.mozAnimation = "heart_beat 2s ease-in-out";
        document.getElementById('currentPlayer').style.oAnimation = "heart_beat 2s ease-in-out";
        setTimeout(function(){
            document.getElementById('currentPlayer').style.cssText = "";
            document.getElementById('currentPlayer').style.color = config.color[nextType];
        }, 2000)
    },
    _initPickedPlayerState: function(pickedPlayerState, chessState){ //显示已经选人了的玩家的状态
        var obj = JSON.parse(pickedPlayerState);
        obj.forEach(function(item){
            if(item.type != 'observer'){
                document.getElementById(item.type+'Btn').setAttribute('disabled', 'true');
                hichat.refreshPlayerState(item);  
                if(hichat.player.name == item.name){
                    hichat.player.type = item.type;
                    hichat.player.state = item.state;
                    //  初始化玩家旗子
                    var chessobj = JSON.parse(chessState);
                    game.init();
                    hichat.player.initChess(chessobj);
                    $('#pickDiv input').attr('disabled', true);
                    if(game.state == config.state.preparing && hichat.player.state == config.state.preparing){
                        $('#prepareBtn').removeAttribute('disabled' );
                    }
                }  
            }else{
                hichat.refreshObserverState(item);
                if(hichat.player.name == item.name){
                    hichat.player.type = item.type;
                    document.getElementById(item.type+'Btn').setAttribute('disabled', 'true');
                    //  初始化观察者旗子
                    var chessobj = JSON.parse(chessState);
                    game.init();
                    hichat.player.initChess(chessobj);
                    $('#playerPickDiv input').attr('disabled', true);
                }
            }
        });
    },
    refreshPlayerState : function(player){
        var online = player.isOnline ? '在线' : '离线';
        var name = player.name;
        var state = player.state;
        var color = player.type;

        var msg = '['+online+'] '+name+' '+state + ' '+ game.getType(color);
        var span = document.createElement('span');
        span.innerHTML = msg;
        var target = document.getElementById(name);
        if(target){
            target.firstChild.remove();
        }else{
            target = document.createElement('div');
            target.setAttribute('id', name);
            document.getElementById('gameWindow').appendChild(target);
        }
        target.appendChild(span);
    },
    refreshObserverState: function(player){
        var online = player.isOnline ? '在线' : '离线';
        var name = player.name;
        var type = '观众席';
        var msg = '['+online+'] '+name+' '+type ;
         var span = document.createElement('span');
        span.innerHTML = msg;
        var target = document.getElementById(name);
        if(target){
            target.firstChild.remove();
        }else{
            target = document.createElement('div');
            target.setAttribute('id', name);
            document.getElementById('gameWindow').appendChild(target);
        }
        target.appendChild(span);
        document.getElementById('prepareBtn').setAttribute('disabled', true);
    },
    initPlayer : function(){
        this.player = new Player();
    },
    broadcastOccupy: function(type, chessId, campId){//广播占营事件
        this.socket.emit('event_occupy',type, chessId, campId);
    },
    broadcastAttack: function(type, chessId, targetChessId){ //广播attack事件
        this.socket.emit('event_attack', type, chessId, targetChessId);
    },
    broadcastExchangeChess: function (firstCampId, secondCampId){
        this.socket.emit('event_exchangeChess_prepare', firstCampId, secondCampId);
    }

}

var Game = function(){
    this.state = config.state.pick;
    this.camps = {};
    this.chesses = {};
}
Game.prototype = {
    init: function(){
        var deg = config.rotate[hichat.player.type];
        this.rotateChessBoard(deg);
        var radian = Math.PI/180 * (360- deg);
        // 中营
        for(var i =0 ; i < middleCampIdxAry.length; i++){
            var row = middleCampIdxAry[i][0];
            var col = middleCampIdxAry[i][1];
            var camp = chessBoard[row][col];
            camp.setSize(chessW, chessW);
            camp.setTextRotate(radian);
            camp.addCamp();
        }
        // 下方 （玩家主视角)
        for(var i = 11; i < 17; i++){
            for(var j= 6; j < 11; j++){
                var camp = chessBoard[i][j];
                camp.colorType = 'green';
                camp.setSize(chessW, chessH);
                camp.addCamp();
            }
        }
        /// 上方
        for(var i = 5; i >= 0; i--){
            for(var j= 6; j < 11; j++){
                var camp = chessBoard[i][j];
                camp.colorType = 'red';
                camp.setSize(chessW, chessH);
                camp.setTextRotate(Math.PI);
                camp.addCamp();
            }
        }
        //  左方
        for(var j = 5; j >=0; j--){
            for(var i= 6; i < 11; i++){
                var camp = chessBoard[i][j];
                camp.colorType = 'yellow';
                camp.setSize(chessH, chessW);
                camp.setTextRotate(Math.PI/2);
                camp.addCamp();
            }
        }
        // 右方
        for(var j = 11; j <17; j++){
            for(var i= 6; i < 11; i++){
                var camp = chessBoard[i][j];
                camp.colorType = 'blue';
                camp.setSize(chessH, chessW);
                camp.setTextRotate(-Math.PI/2);
                camp.addCamp();
            }
        }
    },
    pickCamp: function(e){
        for(var i = 0 ; i < chessBoard.length; i++){
            for(var j =0 ; j < chessBoard[i].length; j++){
                var camp = chessBoard[i][j];
                if(camp.in_camp(e.pageX, e.pageY)){
                    return camp;
                }
            }
        }
        return null;
    },
    showMoveRoute: function(firstCamp, camp, callback){
        var  moveEffectCanvas = document.createElement('canvas');
        moveEffectCanvas.style.position = 'absolute';
        moveEffectCanvas.style.left = 0;
        moveEffectCanvas.style.top = 0;
        moveEffectCanvas.setAttribute('width', window.innerWidth)
        moveEffectCanvas.setAttribute('height', window.innerHeight );       
        document.getElementById('chessBoardDiv').appendChild(moveEffectCanvas);
        var c = moveEffectCanvas.getContext('2d')
        c.lineWidth = 4;
        c.strokeStyle = 'red';
        var isShow = true;
        var showCount = 0;
        var blinkblink = function(){
            if(isShow){
                c.strokeRect(firstCamp.originX-25, firstCamp.originY-25, 45, 45);
                c.strokeRect(camp.originX-25, camp.originY-25, 45, 45);
                isShow = false;
                showCount++;
                if(showCount == 3){
                    document.getElementById('chessBoardDiv').removeChild(moveEffectCanvas);
                    if(callback) callback();
                    return;
                }
            }else{
                c.clearRect(0,0, window.innerWidth, window.innerHeight);
                isShow = true;
            }
            setTimeout(blinkblink, 400);
        }
        blinkblink();
    },

    dieCommander:function(dieCamp){ //如果死的是司令，则该方翻旗
        if(dieCamp.filledChess.name == '司令'){ 
            var type = dieCamp.filledChess.type;
            homeCampIdxAry.forEach(function(item){
                var ary = item.split(",");
                var camp = chessBoard[ary[0]][ary[1]];
                if(camp.filledChess && camp.filledChess.name == '军旗'  && camp.filledChess.type == type){
                    camp.filledChess.isShowName = true;
                    camp.drawChess();
                }
            });
        }
    },
    getType: function(type){
        if(type == 'red'){
            return '红方';
        }else if(type == 'blue'){
            return '蓝方';
        }else if(type == 'yellow'){
            return '黄方';
        }else if(type == 'green'){
            return '绿方';
        }
        return '未选择';
    },
    playerOver: function(type){
        // hichat._displayNewMsg('game', game.getType(type)+'阵亡！ 军旗被抗！', 'red');
        for(var key in this.chesses){
            if(key.startsWith(type)){
                this.chesses[key].destroy();
                delete this.chesses[key];
            }
        }
    },
    rotateChessBoard:function(deg){
        document.getElementById('chessBoardDiv').style.transform = 'rotate('+deg+'deg)';
    }
}

var GameRule = {
    violateChessPosition: function(chess, row, col){
        // 炸弹 和 军旗放错了位置 
        var temp = row+','+col;
        if(chess.name == '军旗'  ){
            if(homeCampIdxAry.indexOf(temp) != -1){
                return false;
            }else{
                console.log('军旗只能在大本营')
                return true;
            }
        }
        if(chess.name == '炸弹'){
            if(row == 11 || row ==5 || col == 5 || col == 11){
                console.log('炸弹不能在第一排')
                return true;
            }else{
                return false;
            }
        }
        if(chess.name == '地雷'){
            if(row == 0 || row == 1 || row == 15 || row == 16 || col == 0 || col == 1 || col == 15 || col == 16){
                return false;
            }
            console.log('地雷得在后两排')
            return true;
        }
        return false;
    } ,
    violateChessExchange:function (player, firstCamp, secondCamp){
        // 交换了其他家旗子
        if(firstCamp.filledChess.type != player.type || secondCamp.filledChess.type != player.type){
            console.log('违反了规则：准备阶段，只能部署自己的棋子');
            return true;
        }
        return false;
    },
    judgment: function(myChess, enemyChess){
        // 如果干过了对方，返回 success
        // 如果没干过，返回     fail
        // 如果一样大，返回     die
        // 如果扛了旗， 返回    win 
        //几个特殊的  炸弹 地雷 军旗
        if(enemyChess.name == '军旗')
        {
            console.log('厉害了我的哥，扛了军旗，你就赢了')
            return config.judgment.win;
        } 
        if(myChess.name == '炸弹' || enemyChess.name =='炸弹' || myChess.name == enemyChess.name){
            console.log('出来混，迟早要还的，双双阵亡')
            return config.judgment.die;
        }
        if(enemyChess.name== '地雷' && myChess.name != '工兵'){
            console.log('哇哦，你挂了')
            return config.judgment.fail;
        }
        var myIdx = pieces.indexOf(myChess.name); 
        var enemyIdx = pieces.indexOf(enemyChess.name);
        if(myIdx > enemyIdx){
            // 没干过
            console.log('哇哦，你挂了')
            return config.judgment.fail;
        }
        if(myIdx < enemyIdx){
            console.log('666，你赢了')
            return config.judgment.success;
        }
    }
}

 

var Observer = function(){
    this.name = '';
    this.isOnline = false; 
}     
Observer.prototype = {
    initChess: function(chessDataSource){
        for(var i =0; i< chessDataSource.length; i++){
            var chess = new Chess();
            chess.id = chessDataSource[i].id;
            chess.name = chessDataSource[i].name;
            chess.isShowName = true;
            chess.fillColor = config.color[chessDataSource[i].type];
            game.camps[chessDataSource[i].campId].addChess(chess);
        }
    }
}

window.onload = function(){
    canvas.setAttribute('width', window.innerWidth );       
    canvas.setAttribute('height', window.innerHeight );       
    function drawBaseGrid(){
        var temp = ['6,7', '6,9',
         '7,6','7,7','7,8','7,9','7,10', 
         '8,7', '8,9',
         '9,6','9,7','9,8','9,9','9,10',
         '10,7', '10,9',
        ];
         for(var i= 0 ; i < maxRows; i++){
            chessBoard[i] = [];
            for(var j = 0 ; j < maxCols ; j++){
                var originX = bounds.lt.x + j*bounds.hgap() ;
                var originY =  bounds.lt.y + i*bounds.vgap();
                var camp = new Camp(originX, originY, i, j);
                if(homeCampIdxAry.indexOf(i+','+j) != -1){
                    camp.type = '大本营';
                }else if(moveCampIdxAry.indexOf(i+','+j) != -1){
                    camp.type = '行营';
                }else if((j < 6 && i < 6) || (j>10 && i < 6) || (j>10 && i > 10) || (j < 6 && i > 10)){
                    camp.type = '';                    
                }else if(temp.indexOf(i+","+j) != -1){
                    camp.type = '';
                }else{
                    camp.type = '兵站';
                }
                chessBoard[i][j] = camp;
            }
        }
        var upBound = {lt: new Vertex2d(0,6),rb: new Vertex2d(5,10)};
        var leftBound = { lt: new Vertex2d(6,0),rb: new Vertex2d(10, 5)};
        var bottomBound = {lt: new Vertex2d(11, 6),rb: new Vertex2d(16, 10)};
        var rightBound = {lt: new Vertex2d(6, 11), rb: new Vertex2d(10, 16)};
        [upBound, leftBound,bottomBound, rightBound].forEach(function(item){
            for(var i = item.lt.x ;i <= item.rb.x; i++){
                var ctx = canvas.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(chessBoard[i][item.lt.y].originX, chessBoard[i][item.lt.y].originY);
                ctx.lineTo(chessBoard[i][item.rb.y].originX, chessBoard[i][item.rb.y].originY);
                ctx.stroke();
            } 
            for(var j =item.lt.y ; j <= item.rb.y; j++){
                var ctx = canvas.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(chessBoard[item.lt.x][j].originX, chessBoard[item.lt.x][j].originY);
                ctx.lineTo(chessBoard[item.rb.x][j].originX, chessBoard[item.rb.x][j].originY);
                ctx.stroke();
            }
        });
    }
    function drawXieXian(){
        for(var i =0 ; i < moveCampIdxAry.length; i++){
            var idxAry = moveCampIdxAry[i].split(',').map(function(item){
                return Number(item);
            });
            var originCamp = chessBoard[idxAry[0]][idxAry[1]];
            var ctx = canvas.getContext('2d');
            var x = idxAry[0] - 1;
            var y = idxAry[1] -1;
            ctx.beginPath();
            var camp = chessBoard[x][y];
            ctx.moveTo(camp.originX, camp.originY);
            ctx.lineTo(originCamp.originX, originCamp.originY);
            ctx.stroke();
            //////
            x = idxAry[0] + 1;
            y = idxAry[1] - 1 ;
            ctx.beginPath();
            camp = chessBoard[x][y];
            ctx.moveTo(camp.originX, camp.originY);
            ctx.lineTo(originCamp.originX, originCamp.originY);
            ctx.stroke();
            ///////
            x = idxAry[0] + 1;
            y = idxAry[1] + 1 ;
            ctx.beginPath();
            camp = chessBoard[x][y];
            ctx.moveTo(camp.originX, camp.originY);
            ctx.lineTo(originCamp.originX, originCamp.originY);
            ctx.stroke();
            ///////
            x = idxAry[0] -1 ;
            y = idxAry[1] + 1 ;
            ctx.beginPath();
            camp = chessBoard[x][y];
            ctx.moveTo(camp.originX, camp.originY);
            ctx.lineTo(originCamp.originX, originCamp.originY);
            ctx.stroke();
        }
    }
    function drawRailRoad(){
        ctx.save();
        ctx.lineWidth = 6;
        for(var key in railRoadRowDic){
            var start = railRoadRowDic[key][0];
            var end = railRoadRowDic[key][railRoadRowDic[key].length - 1]; 
            ctx.beginPath();
            var x = chessBoard[start[1]][start[0]].originX;
            var y = chessBoard[start[1]][start[0]].originY;
            var x1 = chessBoard[end[1]][end[0]].originX;
            var y1 = chessBoard[end[1]][end[0]].originY;
            ctx.moveTo(x, y);
            ctx.lineTo(x1, y1);
            ctx.stroke();
        }
        for(var key in railRoadColDic){
            var start = railRoadColDic[key][0];
            var end = railRoadColDic[key][railRoadColDic[key].length - 1]; 
            ctx.beginPath();
            var x = chessBoard[start[1]][start[0]].originX;
            var y = chessBoard[start[1]][start[0]].originY;
            var x1 = chessBoard[end[1]][end[0]].originX;
            var y1 = chessBoard[end[1]][end[0]].originY;
            ctx.moveTo(x, y);
            ctx.lineTo(x1, y1);
            ctx.stroke();
        }
        [[6,5,5,6],[6,11,5,10],[10,11,11,10],[10,5,11,6]].forEach(function(item, idx){
            ctx.beginPath();
            var x = chessBoard[item[0]][item[1]].originX;
            var y = chessBoard[item[0]][item[1]].originY;
            var x1 = chessBoard[item[2]][item[3]].originX;
            var y1 = chessBoard[item[2]][item[3]].originY;
            ctx.moveTo(x, y);
            ctx.lineTo(x1, y1);
            ctx.stroke();
        });
        ctx.restore();
    }

    function initChessBoard(){
        drawBaseGrid();
        drawXieXian();
        drawRailRoad();
    }
    initChessBoard();
    
    hichat = new HiChat();
    hichat.init();  
    game = new Game();
    // game.mock_preparing = true; //模拟准备状态
    // game.mock_started = true; // 模拟开始状态
}
        
    </script>
</html>
